<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Search Books</title>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <style>
    .book-button {
      width: 100%;
      text-align: left;
      cursor: pointer;
      padding: 8px 12px;
      margin-bottom: 4px;
      border: 1px solid var(--ds-border, rgba(9, 30, 66, 0.13));
      border-radius: 3px;
      background-color: var(--ds-background-neutral, #fff);
      color: var(--ds-text, #172b4d);
      transition: background-color 0.1s ease;
    }

    .book-button:hover {
      background-color: var(--ds-background-neutral-hovered, #f4f5f7);
    }

    .message-text {
      padding: 12px;
      color: var(--ds-text-subtle, #5e6c84);
    }

    .error-text {
      padding: 12px;
      color: var(--ds-text-danger, #de350b);
    }
  </style>
</head>

<body>

  <div class="u-clearfix">
    <input type="text" id="search-input" class="full" placeholder="Search for books...">
    <ul id="results" class="u-overflow-auto"></ul>
  </div>

  <!-- 
      We're going to use client.js to help us make requests to Trello's API.
      client.js is not the same as the client library for Power-Up's. client.js
      is a helper library that is a wrapper for the API. It relies on jquery's
      XHR methods, so we need to bring in jquery first
    -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

  <!-- Don't forget to add your API key into the script tag for client.js! -->
  <script src="https://trello.com/1/client.js?key=your_key_here"></script>

  <!-- And because we're ALSO doing Power-Up-related things, we still need the Power-Up client library -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>

  <!-- Book API Provider Abstraction -->
  <script type="module">
    import { BookAPIProvider } from './js/book-api-provider.js';

    let bookDataStore = {};
    $(document).ready(function () {

      // Initialize the Power-Up client library and include your app name and API key
      var t = window.TrelloPowerUp.iframe({
        appKey: import.meta.env.VITE_TRELLO_APP_KEY,
        appName: 'Book details'
      });
      t.card('name').get('name').then(function (fetchedCardName) {
        $('#search-input').val(fetchedCardName).trigger('input');
      });
      /*
        This script listens for input events on the element with the ID 'search-input'.
        When the input value changes, it checks if the length of the input value (query) is greater than 2 characters.
        If the query length is greater than 2, it searches for books using the configured API provider.
        The response data is normalized and displayed as clickable buttons.
        The formatted list is inserted into the element with the ID 'results'.
        If the query length is 2 characters or less, the 'results' element is cleared.
      */
      $('#search-input').on('input', function () {
        const query = $(this).val();
        if (query.length > 2) {
          // Show loading state
          $('#results').html(`<p class="message-text">Searching for books (${BookAPIProvider.getProvider()})...</p>`);

          // Use the book API provider abstraction
          BookAPIProvider.search(query)
            .then(function (books) {
              // reset the book data store
              bookDataStore = {};

              // Check if any books were found
              if (!books || books.length === 0) {
                $('#results').html('<p class="message-text">No books found.</p>');
                return;
              }

              const results = books.map(bookData => {
                // Store book data with ID as key
                bookDataStore[bookData.id] = bookData;

                return `<button class='book-button' data-book-id="${bookData.id}">
                  ${bookData.title} by ${bookData.author}
                </button>`;
              }).join('');
              $('#results').html(results);
            })
            .catch(function (error) {
              console.error('Book API error:', error);
              $('#results').html('<p class="error-text">Error searching for books. Please try again.</p>');
            });
        } else {
          $('#results').empty();
        }
      });

      /*
        This script listens for click events on elements with the class 'book-button'.
        When a 'book-button' element is clicked, it retrieves the 'id' data attribute of the clicked element.
        The 'id' attribute is then stored in the shared state of the Power-Up using the 'set' method.
        Finally, the popup is closed.
      */
      $(document).on('click', '.book-button', function () {
        const bookId = $(this).data('book-id');
        const bookData = bookDataStore[bookId];
        // remove previous attachments that start with https://openlibrary.org
        // ... doesn't seem to have this functionality. would have to use the rest api
        // add new attachments
        t.attach({ url: bookData.infoLink, name: bookData.title + ' -- by: ' + bookData.author });
        t.attach({ url: bookData.cover, name: bookData.title + ' -- cover', setCover: true })
        t.set('card', 'shared', 'bookData', JSON.stringify(bookData))
          .then(() => t.closePopup());
      });



    });
  </script>
</body>

</html>